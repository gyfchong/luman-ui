name: Auto Changeset

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]

jobs:
  auto-changeset:
    # Skip if PR title contains [skip changeset]
    if: "!contains(github.event.pull_request.title, '[skip changeset]')"
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.0.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check for existing changesets
        id: check
        run: |
          # Count .md files in .changeset/ excluding README.md
          changeset_count=$(find .changeset -name "*.md" ! -name "README.md" -type f | wc -l)
          if [ "$changeset_count" -gt 0 ]; then
            echo "has_changesets=true" >> $GITHUB_OUTPUT
            echo "Found $changeset_count existing changeset(s)"
          else
            echo "has_changesets=false" >> $GITHUB_OUTPUT
            echo "No existing changesets found"
          fi

      - name: Generate changeset
        if: steps.check.outputs.has_changesets == 'false'
        run: pnpm tsx scripts/auto-changeset.ts

      - name: Check for changes
        if: steps.check.outputs.has_changesets == 'false'
        id: changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes to commit"
          fi

      - name: Commit and push changeset
        if: steps.check.outputs.has_changesets == 'false' && steps.changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .changeset/*.md packages/ui/src/registry/items/*.json
          git commit -m "chore: auto-generate changeset and bump component versions"
          git push

      - name: Post PR comment
        if: steps.check.outputs.has_changesets == 'false' && steps.changes.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Read the generated changeset
            const changesetDir = '.changeset';
            const files = fs.readdirSync(changesetDir);
            const changesetFile = files.find(f => f.startsWith('auto-') && f.endsWith('.md'));

            let changesetContent = '';
            if (changesetFile) {
              changesetContent = fs.readFileSync(path.join(changesetDir, changesetFile), 'utf-8');
            }

            // Check for registry updates
            const registryDir = 'packages/ui/src/registry/items';
            let registryUpdates = [];
            if (fs.existsSync(registryDir)) {
              const items = fs.readdirSync(registryDir).filter(f => f.endsWith('.json'));
              for (const item of items) {
                const itemPath = path.join(registryDir, item);
                const content = JSON.parse(fs.readFileSync(itemPath, 'utf-8'));
                registryUpdates.push(`- **${content.name}** â†’ v${content.version}`);
              }
            }

            const commentBody = `## ðŸ¤– Auto-Changeset Generated

            A changeset has been automatically generated based on your conventional commit messages.

            ${changesetContent ? `### Package Changes\n\n\`\`\`\n${changesetContent}\n\`\`\`` : ''}

            ${registryUpdates.length > 0 ? `### Component Registry Updates\n\n${registryUpdates.join('\n')}` : ''}

            ---

            ðŸ’¡ **Tip**: You can edit the changeset file before merging, or add \`[skip changeset]\` to your PR title to skip auto-generation.`;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: commentBody
            });

      - name: No changeset needed
        if: steps.check.outputs.has_changesets == 'false' && steps.changes.outputs.has_changes == 'false'
        run: echo "No changeset or component updates needed for these changes"
